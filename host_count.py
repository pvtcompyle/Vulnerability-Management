from libs.vulm import *
import os
from colorama import Fore, Back, Style
################
## Initialize ##
################
resultsdir = 'results'
hostsdir = 'results\\hosts'

# Setup working directory and get a list of all csv's in the directory
dir=os.getcwd()
os.chdir(dir)
csvlist = getcsv()
scandate = (gettoday())
consolidatedfile = scandate + "_ScanResults.csv"
consolidatedfile = os.path.join(resultsdir, consolidatedfile)

# Create output directories to store output files 
try:
    os.mkdir(resultsdir)
except Exception:
    pass
try:
    os.mkdir('results\\hosts')
except Exception:
    pass

###########
## Start ##
###########

for f in csvlist:
    print('\nProcessing', f)
    parsetrash(f)

print('\nConsolidating files ...')
consolidatescans(csvlist, scandate, resultsdir, consolidatedfile)
print('\nTotal hosts scanned: ', countinstance(consolidatedfile, 'Host'))

print('\nSeperating hosts into individual files ...')
hosts = seperatehosts(consolidatedfile, dir)

avgCVSS = avgfield(consolidatedfile, 'CVSS')
print("\nAverage CVSS score: ", avgCVSS)

print('Host summaries')
print('==============')
summary(hosts, hostsdir)