# Version 2.0
# Created by: Thunder Sargent
from libs.vulm import *
import sys
from colorama import Style, Fore
import pandas as pd
import re
import os
import glob
import numpy as np
################
## Initialize ##
################
resultsdir = 'results'
hostsdir = 'results\\hosts'

# Setup working directory and get a list of all csv's in the directory
dir=os.getcwd()
os.chdir(dir)
csvlist = getcsv()
scandate = (getlastmonth())
consolidatedfile = scandate + "_ScanResults.csv"
consolidatedfile = os.path.join(resultsdir, consolidatedfile)
summaryfile = 'results\\' + scandate + '_Summary.csv'

# Create output directories to store output files 
try:
    os.mkdir(resultsdir)
except Exception:
    pass
try:
    os.mkdir('results\\hosts')
except Exception:
    pass

###########
## Start ##
###########
print(csvlist)
if not input("Are you sure? (y/n): ").lower().strip()[:1] == "y": sys.exit(1)

print('\nConsolidating files ...')
consolidatescans(csvlist, scandate, resultsdir, consolidatedfile)

print('\nSeperating hosts into individual files ...')
hosts = seperatehosts(consolidatedfile, dir)
print('Parsing the trash from individual host files ...')

cons_data_frame = getDataFrame(consolidatedfile)
print('\nGenerating summary report ...')
summary(cons_data_frame, summaryfile)
print('Summary report complete. ')
print('\nTotal hosts scanned: ', countinstance(consolidatedfile, 'Host'))
print('Total detections found: ', len(cons_data_frame))
print("Average CVSS score: ", round(cons_data_frame['CVSS'].mean(), 2))